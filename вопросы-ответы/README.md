# Перечень вопросов и ответов по CPI
Он же FAQ CPI. Двуязычный (англ+рус) писать нет желания, проще "для своих" по-русски. АргхЪ!

<iliya.kuznetsov@gmail.com> 2020-09-29-003

## Neo vs CloudFoundry

### Что будет с текущими контрактами в Neo?
Все контракты в Neo будут выполняться со стороны вендора неукоснительно, до даты подписания.

### Когда CloudFoundry появится в ЦОД ru1 (Ростелеком Москва)?
Вопрос открыт - в 2020м не будет, про 2021 ясной информации нет.

### Можно ли при заключении нового контракта на CPI выбрать тип ЦОД?
Нет. Будет только CF.

### В чём отличия и зачем переходить?
Изначально в 2013г все собственные облачные сервисы SAP работали на Neo (тогда это была HANA Cloud Platform, затем SAP Cloud Platform); всякие Арибы и СаксессФакторсы не в счёт.
По мере перехода линейки прочих сервисов с Neo на CF весной 2019 тема миграции коснулась и CPI, см. ноту 2752867, последняя версия 203 от 26 августа 2020.

Пока планируется поддерживать одинаковые версии CPI и библиотек (Camel, Groovy) в обоих ЦОД, а в будущем - как получится. Но соображения совместимости обязательно будут учтены.

Из технических деталей:
* В CF нет RFC Receiver/Producer адаптера, либо он не будет работать с клауд коннектором (//TODO - уточнить). Причина - в субаккаунте CF нельзя
указать RFC Destination как это можно в Neo.
* Разработчики не-SAP адаптеров, той же Advantco и Figaf должны портировать свой код на CF и сейчас этот процесс идёт.

Отличное видео на русском языке - см. https://youtu.be/cNvVsbanWOM

### Как переходить? Что автоматизировано переносится?
Есть визард миграции упакованный в запросы Postman. См. видео из предыдущего вопроса.

## Архитектура в целом

### Контейнеры и OSGI
Отличный рассказ на русском языке - https://youtu.be/IFPZZ6yG1Tc и материалы https://github.com/rsugio/PIMON/tree/master/PIMON-2020/01_CPI_Runtime

## Компиляция IFLOW в Blueprint
//TODO

### Как понять из IFlow BPMN какой код среды выполнения получился?
// TODO

## Расписания

### Как запланировать задание в последний день месяца?
Красивый способ - свой адаптер с произвольным крон-расписанием.
Некрасивые:
* Планировать задание на следующий месяц руками
* Сделать 12 таймеров-сендеров и планировать раз в год руками
* Запускаться каждый день и в скрипте/роутере смотреть не последний ли

### Если несколько рабочих нод то сообщение по таймеру стартует везде сразу, как с этим бороться в мониторинге?
В октябре 2020 появился статус DISCARDED для тех рабочих нод где не запускалось реально.

## Адаптеры

### Как прочитать/удалить файл с SFTP по запросу из CPI?

### Как сделать асинхронный HTTP Sender/Consumer?
Про Receiver/Producer речь не идёт, нам нужен ответ веб-сервера чтобы код возврата проанализировать.

Штатный веб-сервер на стороне CPI который является сервлетом в /http/ заточен на MEP=InOut и неявно пробрасывает последнее сообщение в маршруте обратно вызывающей стороне, поэтому если у нас длинная-длинная обработка начинающаяся от HTTPS Sender канала то пока всё не закончится, вызывающий клиент не получит никакого ответа.

Такое поведение иногда неудобно, например - хотим снаружи в CPI передать какой-то вход, быстро проверить его и выдать статус про принято оно в работу или нет (202 Accepted или даже 208 Already Reported и 400 Bad Request для ошибки).

Для SOAP мы можем реализовать явный асинхронный сервис в CPI (есть и InOut и InOnly), почему в HTTP такого нет?

Хороший способ это написать свой адаптер-сервлет в /customhttp/.
Костыли следующие:
* Сделать мостик из InOut в InOnly

  Делаем в одном IFLOW два глобальных потока:
  1. HTTPS#1 Sender -> валидация и обработка -> SOAP#2 Request-Reply -> выдача кода возврата и сообщения
  2. SOAP#2 Sender InOnly без ReliableMessaging -> долговременная обработка
  
  В таком случае в мониторинге будет две строчки запуска и разрыв потока позволит в ветке #1 вернуть быстрый ответ, а обработка в ветке #2 будет крутиться хоть месяц.
  
  ```Поток #2 не может быть ProcessDirect так как этот внутренний "протокол" только синхронный.```
  
* Промежуточное хранилище в DataStore или в JMS или даже в файле

  Всё просто, складываем из HTTPS Sender в хранилище и оттуда чем-то вычитываем.
  
* //TODO вспомнить ещё из обсуждения

### SuccessFactors Receiver/Producer - фильтр с символами
//TODO

Почему CPI не воспринимает некоторые спецсимволы? У меня в строке фильтра встречается символ "|" например.

Делаю по этой ноте - https://launchpad.support.sap.com/#/notes/0002917161 , убираю строку фильтра в проперти и вставляю в запрос как ${property.value}

часть спецсимволов, например нижнее подчеркивание и слеш воспринимаются нормально, другие, например | и обратный слеш вызывают ошибку Illegal character in query

вот пример: $filter=code%20eq%20%27abc/de/107/10710\0035%27
кавычки и пробелы конвертировал в %20 и %27, обратный слеш оставил

в запросе $filter=code eq ${property.code}

и он это выдает вот в таком виде, который я выше скинул

причем, если фильтр взять в кавычки он воспринимает это просто как строку и работает запрос, но не работает поиск

но если константой подпихнуть вертикальные палки, то он уже воспринимает это не как строку и ломает URI

замкнутый круг какой-то

## Скрипты

### Повторное использование кода

## Клауд коннектор (SCC, SAP Cloud Connector)

### Как зарегистрировать SCC в CF?

### Можно ли с помощью SCC обращаться к наземной локальной файловой системе?
